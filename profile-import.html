<!DOCTYPE html>
<html lang="en">
<head>
    <link href="https://db.onlinewebfonts.com/c/28c0ba929947563500b21da15a88c6fe?family=TacticSans-Reg" rel="stylesheet"/>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Cocoon Aluminum Works - Profile Management</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&family=Open+Sans:wght@300;400;600&display=swap" rel="stylesheet"/>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <!-- Your Firebase config -->
    <script src="config.js"></script>
    <script src="auth.js"></script>
    
    <style>
        :root {
            --cocoon-primary: #A72036;
            --cocoon-dark: #303038;
            --cocoon-light: #F9BC77;
            --cocoon-white: #FFFFFF;
            --cocoon-light-bg: #f8f8f8;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background-color: var(--cocoon-light-bg);
            color: var(--cocoon-dark);
            font-family: "TacticSans-Reg", sans-serif;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        /* Header */
        .brand-header {
            background-color: var(--cocoon-white);
            padding: 15px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .brand-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            width: 200px;
            height: auto;
        }
        
        .nav-links {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .nav-links a {
            color: var(--cocoon-dark);
            text-decoration: none;
            font-weight: 600;
            transition: color 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .nav-links a:hover {
            color: var(--cocoon-primary);
        }
        
        /* Main Content */
        .main-content {
            padding: 30px 0;
        }
        
        .page-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .page-title {
            font-size: 2.5rem;
            color: var(--cocoon-primary);
            margin-bottom: 10px;
        }
        
        .page-subtitle {
            font-size: 1.2rem;
            color: var(--cocoon-dark);
            opacity: 0.8;
        }
        
        /* Tabs */
        .tab-container {
            background: var(--cocoon-white);
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .tab-buttons {
            display: flex;
            border-bottom: 2px solid var(--cocoon-light-bg);
        }
        
        .tab-btn {
            flex: 1;
            padding: 20px;
            background: none;
            border: none;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--cocoon-dark);
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }
        
        .tab-btn.active {
            color: var(--cocoon-primary);
            border-bottom-color: var(--cocoon-primary);
            background-color: rgba(167, 32, 54, 0.05);
        }
        
        .tab-btn:hover {
            background-color: rgba(167, 32, 54, 0.05);
        }
        
        .tab-content {
            display: none;
            padding: 30px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Form Styles */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--cocoon-dark);
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--cocoon-primary);
        }
        
        .form-group input[readonly] {
            background-color: #f8f9fa;
            color: #495057;
            cursor: not-allowed;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background-color: var(--cocoon-primary);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #8a1a2d;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background-color: var(--cocoon-light);
            color: var(--cocoon-dark);
        }
        
        .btn-secondary:hover {
            background-color: #f0a85a;
        }
        
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c82333;
        }
        
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #218838;
        }
        
        .btn-warning {
            background-color: #ffc107;
            color: var(--cocoon-dark);
        }
        
        .btn-warning:hover {
            background-color: #e0a800;
        }
        
        .btn-info {
            background-color: #17a2b8;
            color: white;
        }
        
        .btn-info:hover {
            background-color: #138496;
        }
        
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #218838;
        }
        
        /* Table Styles */
        .table-container {
            background: var(--cocoon-white);
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .table-header {
            background-color: var(--cocoon-primary);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .table-title {
            font-size: 1.3rem;
            font-weight: 600;
        }
        
        .table-actions {
            display: flex;
            gap: 10px;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th,
        .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .data-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: var(--cocoon-dark);
        }
        
        .data-table tr:hover {
            background-color: rgba(167, 32, 54, 0.05);
        }
        
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 0.9rem;
        }
        
        /* Search and Filter */
        .search-filter {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }
        
        .search-input {
            flex: 1;
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--cocoon-primary);
        }
        
        /* Status Messages */
        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        
        .status-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .search-filter {
                flex-direction: column;
                align-items: stretch;
            }
            
            .table-container {
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="brand-header">
        <div class="container">
            <div class="brand-container">
                <div>
                    <h1 style="color: var(--cocoon-primary); font-size: 1.8rem; margin: 0;">Cocoon Aluminum Works</h1>
                    <p class="tagline" style="margin: 5px 0 0 0; font-size: 0.9rem;">Profile Management System</p>
                </div>
                <nav class="nav-links">
                    <a href="dashboard.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
                    <a href="quote-generator.html"><i class="fas fa-calculator"></i> Quote Calculator</a>
                    <a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a>
                </nav>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Page Header -->
            <div class="page-header">
                <h1 class="page-title">Profile Management</h1>
                <p class="page-subtitle">Import, manage, and organize aluminum profiles for pricing calculations</p>
            </div>

            <!-- Status Messages -->
            <div id="statusMessage" class="status-message"></div>

            <!-- Tab Container -->
            <div class="tab-container">
                <div class="tab-buttons">
                    <button class="tab-btn active" onclick="switchTab('import')">
                        <i class="fas fa-upload"></i> Import Profiles
                    </button>
                    <button class="tab-btn" onclick="switchTab('google-sheets')">
                        <i class="fas fa-table"></i> Google Sheets Import
                    </button>
                    <button class="tab-btn" onclick="switchTab('manage')">
                        <i class="fas fa-list"></i> Manage Profiles
                    </button>
                    <button class="tab-btn" onclick="switchTab('export')">
                        <i class="fas fa-download"></i> Export Data
                    </button>
                </div>

                <!-- Import Tab -->
                <div id="import" class="tab-content active">
                    <h2 style="margin-bottom: 20px; color: var(--cocoon-primary);">Import Profiles</h2>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="profileCode">Profile Code *</label>
                            <input type="text" id="profileCode" placeholder="e.g., ALU-WIN-001" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="profileName">Profile Name *</label>
                            <input type="text" id="profileName" placeholder="e.g., Premium Sliding Window" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="brand">Brand</label>
                            <input type="text" id="brand" placeholder="e.g., Cocoon, Premium">
                        </div>
                        
                        <div class="form-group">
                            <label for="system">System</label>
                            <select id="system" required>
                                <option value="">Select System Type</option>
                                <option value="Sliding">Sliding</option>
                                <option value="Hinged">Hinged</option>
                                <option value="Curtain Wall">Curtain Wall</option>
                                <option value="Fixed">Fixed</option>
                                <option value="Folding">Folding(Soon)</option>
                                
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="maxHeight">Max Height (mm)</label>
                            <input type="number" id="maxHeight" placeholder="e.g., 3000">
                        </div>
                        
                        <div class="form-group">
                            <label for="maxWidth">Max Width (mm)</label>
                            <input type="number" id="maxWidth" placeholder="e.g., 6000">
                        </div>
                    </div>

                    <h3 style="margin: 20px 0; color: var(--cocoon-dark);">Pricing Information</h3>
                    
                    <div style="margin-bottom: 20px; padding: 15px; background: #e8f5e8; border-radius: 8px; border-left: 4px solid #28a745;">
                        <h4 style="margin-bottom: 10px; color: #28a745;">💡 Automatic Price Calculation</h4>
                        <p style="margin-bottom: 5px; font-size: 0.9rem;">Enter the <strong>KG Price</strong> and <strong>6-meter weights</strong> below. The system will automatically calculate the meter prices using the formula:</p>
                        <p style="margin-bottom: 0; font-size: 0.9rem; font-family: monospace; color: #666;">Meter Price = (6m Weight × KG Price) ÷ 6</p>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="kgPrice">KG Price (EGP/kg) *</label>
                            <input type="number" id="kgPrice" step="0.01" placeholder="e.g., 15.50" oninput="calculateMeterPrices()">
                        </div>
                        
                        <div class="form-group">
                            <label for="frameWeight6m">Frame Weight (6m) *</label>
                            <input type="number" id="frameWeight6m" step="0.01" placeholder="e.g., 25.00" oninput="calculateMeterPrices()">
                        </div>
                        
                        <div class="form-group">
                            <label for="framePrice">Frame Price (EGP/m) - Auto Calculated</label>
                            <div style="position: relative;">
                                <input type="number" id="framePrice" step="0.01" placeholder="Auto calculated" readonly>
                                <div id="framePriceIndicator" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #28a745; font-size: 0.8rem; display: none;">✓</div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="frameWeight3Leaf6m">Frame Weight 3-Leaf (6m)</label>
                            <input type="number" id="frameWeight3Leaf6m" step="0.01" placeholder="e.g., 30.00" oninput="calculateMeterPrices()">
                        </div>
                        
                        <div class="form-group">
                            <label for="framePrice3">Frame Price 3-Leaf (EGP/m) - Auto Calculated</label>
                            <div style="position: relative;">
                                <input type="number" id="framePrice3" step="0.01" placeholder="Auto calculated" readonly>
                                <div id="framePrice3Indicator" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #28a745; font-size: 0.8rem; display: none;">✓</div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="leafWeight6m">Leaf Weight (6m)</label>
                            <input type="number" id="leafWeight6m" step="0.01" placeholder="e.g., 12.00" oninput="calculateMeterPrices()">
                        </div>
                        
                        <div class="form-group">
                            <label for="leafPrice">Leaf Price (EGP/m) - Auto Calculated</label>
                            <div style="position: relative;">
                                <input type="number" id="leafPrice" step="0.01" placeholder="Auto calculated" readonly>
                                <div id="leafPriceIndicator" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #28a745; font-size: 0.8rem; display: none;">✓</div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="accessories2Leaves">Accessories 2-Leaves (EGP)</label>
                            <input type="number" id="accessories2Leaves" step="0.01" placeholder="e.g., 50.00">
                        </div>
                        
                        <div class="form-group">
                            <label for="accessories3Leaves">Accessories 3-Leaves (EGP)</label>
                            <input type="number" id="accessories3Leaves" step="0.01" placeholder="e.g., 75.00">
                        </div>
                        
                        <div class="form-group">
                            <label for="accessories4Leaves">Accessories 4-Leaves (EGP)</label>
                            <input type="number" id="accessories4Leaves" step="0.01" placeholder="e.g., 100.00">
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label for="glassPriceSingle">Glass Price Single (EGP/m²)</label>
                            <input type="number" id="glassPriceSingle" step="0.01" placeholder="e.g., 80.00">
                        </div>
                        
                        <div class="form-group">
                            <label for="glassPriceDouble">Glass Price Double (EGP/m²)</label>
                            <input type="number" id="glassPriceDouble" step="0.01" placeholder="e.g., 120.00">
                        </div>
                        
                        <div class="form-group">
                            <label for="arcPrice">Arch Price (EGP)</label>
                            <input type="number" id="arcPrice" step="0.01" placeholder="e.g., 200.00">
                        </div>
                        
                        <div class="form-group">
                            <label for="netPrice">Net Price (EGP/m²)</label>
                            <input type="number" id="netPrice" step="0.01" placeholder="e.g., 60.00">
                        </div>
                        
                        <div class="form-group">
                            <label for="netPricePlisse">Net Price Plisse (EGP/m²)</label>
                            <input type="number" id="netPricePlisse" step="0.01" placeholder="e.g., 80.00">
                        </div>
                        
                        <div class="form-group">
                            <label for="netPricePanda">Net Price Panda (EGP/m²)</label>
                            <input type="number" id="netPricePanda" step="0.01" placeholder="e.g., 100.00">
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label for="baseProfitRate">Base Profit Rate (%)</label>
                            <input type="number" id="baseProfitRate" step="0.1" placeholder="e.g., 30.0" value="30">
                        </div>
                        
                        <div class="form-group">
                            <label for="notes">Notes</label>
                            <textarea id="notes" rows="3" placeholder="Additional notes about this profile..."></textarea>
                        </div>
                    </div>

                    <div style="margin-top: 30px; display: flex; gap: 15px;">
                        <button class="btn btn-primary" onclick="addProfile()">
                            <i class="fas fa-plus"></i> Add Profile
                        </button>
                        <button class="btn btn-secondary" onclick="clearForm()">
                            <i class="fas fa-eraser"></i> Clear Form
                        </button>
                        <button class="btn btn-success" onclick="importFromCSV()">
                            <i class="fas fa-file-csv"></i> Import from CSV
                        </button>
                    </div>
                </div>

                <!-- Google Sheets Import Tab -->
                <div id="google-sheets" class="tab-content">
                    <h2 style="margin-bottom: 20px; color: var(--cocoon-primary);">Google Sheets Import</h2>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="googleSheetId">Google Sheet ID *</label>
                            <input type="text" id="googleSheetId" placeholder="e.g., 121dOot1VcbF6NRdB_fvQiYulACjT3edcPWgmXp0kSaA" value="121dOot1VcbF6NRdB_fvQiYulACjT3edcPWgmXp0kSaA">
                            <small style="color: #666; margin-top: 5px; display: block;">The ID from your Google Sheet URL</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="googleSheetGid">Sheet GID *</label>
                            <input type="text" id="googleSheetGid" placeholder="e.g., 1602477751" value="1602477751">
                            <small style="color: #666; margin-top: 5px; display: block;">The GID from your Google Sheet URL</small>
                        </div>
                    </div>

                    <div style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid var(--cocoon-primary);">
                        <h4 style="margin-bottom: 10px; color: var(--cocoon-primary);">Your Sheet Structure</h4>
                        <p style="margin-bottom: 10px;">Your Google Sheet has these columns (system will automatically map them):</p>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 10px; font-family: monospace; font-size: 0.9rem;">
                            <div><strong>profile_code</strong> ✅ - Unique profile identifier</div>
                            <div><strong>Brand</strong> ✅ - Brand name (will map to 'brand')</div>
                            <div><strong>profile_name</strong> ✅ - Profile display name</div>
                            <div><strong>kg_price</strong> ⚠️ - Additional field (not used in calculations)</div>
                            <div><strong>frame_price</strong> ✅ - Frame price (EGP/m)</div>
                            <div><strong>frame_price_3</strong> ✅ - 3-leaf frame price</div>
                            <div><strong>leaf_price</strong> ✅ - Leaf price (EGP/m)</div>
                            <div><strong>Accessories 2X/windows cost</strong> ✅ - 2-leaves accessories</div>
                            <div><strong>Accessories 3X/frame cost</strong> ✅ - 3-leaves accessories</div>
                            <div><strong>Accessories 4X/corners cost</strong> ✅ - 4-leaves accessories</div>
                            <div><strong>net_price</strong> ✅ - Net price</div>
                            <div><strong>net_price_plisse</strong> ✅ - Plisse net price</div>
                            <div><strong>net_price_panda</strong> ✅ - Panda net price</div>
                            <div><strong>arc_price</strong> ✅ - Arch price</div>
                            <div><strong>system</strong> ✅ - System type</div>
                            <div><strong>max_h</strong> ✅ - Maximum height (mm)</div>
                            <div><strong>max_w</strong> ✅ - Maximum width (mm)</div>
                            <div><strong>base_profit_rate</strong> ✅ - Base profit rate (%)</div>
                        </div>
                        <p style="margin-top: 10px; color: #666; font-size: 0.9rem;">✅ Required fields | ⚠️ Additional fields (will be preserved but not used in calculations)</p>
                    </div>

                    <div style="margin: 20px 0;">
                        <button class="btn btn-primary" onclick="testGoogleSheetConnection()">
                            <i class="fas fa-wifi"></i> Test Connection
                        </button>
                        <button class="btn btn-success" onclick="importFromGoogleSheets()">
                            <i class="fas fa-cloud-download-alt"></i> Import All Profiles
                        </button>
                        <button class="btn btn-secondary" onclick="previewGoogleSheetData()">
                            <i class="fas fa-eye"></i> Preview Data
                        </button>
                        <button class="btn btn-warning" onclick="downloadSampleCSV()">
                            <i class="fas fa-download"></i> Download Sample CSV
                        </button>
                        <button class="btn btn-info" onclick="debugColumnNames()">
                            <i class="fas fa-bug"></i> Debug Column Names
                        </button>
                        <button class="btn btn-success" onclick="testImportDirectly()">
                            <i class="fas fa-play"></i> Test Import Directly
                        </button>
                        <button class="btn btn-warning" onclick="debugProfiles()">
                            <i class="fas fa-bug"></i> Debug Profiles
                        </button>
                        <button class="btn btn-primary" onclick="forceDisplayProfiles()">
                            <i class="fas fa-eye"></i> Force Display
                        </button>
                        <button class="btn btn-secondary" onclick="testProfilesDisplay()">
                            <i class="fas fa-check"></i> Test Profiles
                        </button>
                    </div>

                    <div id="googleSheetStatus" class="status-message"></div>
                    
                    <div id="googleSheetPreview" style="display: none; margin-top: 20px;">
                        <h3 style="margin-bottom: 15px; color: var(--cocoon-dark);">Sheet Preview</h3>
                        <div class="table-container">
                            <table class="data-table" id="previewTable">
                                <thead>
                                    <tr>
                                        <th>Code</th>
                                        <th>Name</th>
                                        <th>Brand</th>
                                        <th>System</th>
                                        <th>Frame Price</th>
                                        <th>Leaf Price</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="previewTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Manage Tab -->
                <div id="manage" class="tab-content">
                    <div class="table-header">
                        <h2 class="table-title">Profile List</h2>
                        <div class="table-actions">
                            <button class="btn btn-secondary" onclick="refreshProfiles()">
                                <i class="fas fa-sync"></i> Refresh
                            </button>
                            <button class="btn btn-danger" onclick="clearAllProfiles()">
                                <i class="fas fa-trash"></i> Clear All
                            </button>
                        </div>
                    </div>
                    
                    <div style="padding: 20px;">
                        <div class="search-filter">
                            <input type="text" id="searchProfiles" class="search-input" placeholder="Search profiles by code, name, or brand...">
                            <select id="filterBrand" style="padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                                <option value="">All Brands</option>
                            </select>
                        </div>
                        
                        <div class="table-container">
                            <table class="data-table" id="profilesTable">
                                <thead>
                                    <tr>
                                        <th>Code</th>
                                        <th>Name</th>
                                        <th>Brand</th>
                                        <th>System</th>
                                        <th>Frame Price</th>
                                        <th>Leaf Price</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="profilesTableBody">
                                    <!-- Profiles will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Export Tab -->
                <div id="export" class="tab-content">
                    <h2 style="margin-bottom: 20px; color: var(--cocoon-primary);">Export Data</h2>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="exportFormat">Export Format</label>
                            <select id="exportFormat">
                                <option value="csv">CSV File</option>
                                <option value="json">JSON File</option>
                                <option value="excel">Excel File (XLSX)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="exportFilter">Filter by Brand</label>
                            <select id="exportFilter">
                                <option value="">All Profiles</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px; display: flex; gap: 15px;">
                        <button class="btn btn-primary" onclick="exportProfiles()">
                            <i class="fas fa-download"></i> Export Profiles
                        </button>
                        <button class="btn btn-secondary" onclick="exportQuotes()">
                            <i class="fas fa-file-alt"></i> Export Quotes
                        </button>
                        <button class="btn btn-success" onclick="backupAllData()">
                            <i class="fas fa-database"></i> Backup All Data
                        </button>
                    </div>
                    
                    <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                        <h3 style="margin-bottom: 15px; color: var(--cocoon-dark);">Data Statistics</h3>
                        <div id="dataStats">
                            <!-- Statistics will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Hidden file input for CSV import -->
    <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="handleCSVImport(event)">

    <script>
        // Global variables
        let profiles = [];
        let currentTab = 'import';

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Profile Import Page Loaded');
            
            // Initialize Firebase Auth
            try {
                await FirebaseAuth.initializeAuth();
                console.log('Firebase Auth initialized');
            } catch (error) {
                console.error('Error initializing Firebase Auth:', error);
            }
            
            // Test basic functionality
            testBasicFunctionality();
            
            await loadProfiles();
            setupEventListeners();
            updateDataStats();
            
            // Set up auto-sync with other pages
            setupAutoSync();
            
            // Auto-load from Google Sheets if no profiles exist
            if (profiles.length === 0) {
                autoLoadFromGoogleSheets();
            }
            
            // Ensure profiles are displayed if we're on the manage tab
            setTimeout(() => {
                if (currentTab === 'manage') {
                    console.log('Initial display on manage tab');
                    displayProfiles();
                }
            }, 100);
        });

        // Test basic functionality
        function testBasicFunctionality() {
            try {
                console.log('Testing basic functionality...');
                
                // Test DOM elements
                const requiredElements = [
                    'profileCode', 'profileName', 'brand', 'system',
                    'maxHeight', 'maxWidth', 'framePrice', 'leafPrice',
                    'googleSheetId', 'googleSheetGid', 'searchProfiles',
                    'profilesTableBody', 'statusMessage'
                ];
                
                const missingElements = [];
                requiredElements.forEach(id => {
                    if (!document.getElementById(id)) {
                        missingElements.push(id);
                    }
                });
                
                if (missingElements.length > 0) {
                    console.error('Missing DOM elements:', missingElements);
                    showStatus(`Missing elements: ${missingElements.join(', ')}`, 'error');
                } else {
                    console.log('All required DOM elements found');
                }
                
                // Test localStorage
                try {
                    localStorage.setItem('test', 'test');
                    localStorage.removeItem('test');
                    console.log('localStorage is working');
                } catch (e) {
                    console.error('localStorage not available:', e);
                    showStatus('localStorage not available - some features may not work', 'warning');
                }
                
                // Test fetch
                if (typeof fetch !== 'undefined') {
                    console.log('Fetch API is available');
                } else {
                    console.error('Fetch API not available');
                    showStatus('Fetch API not available - Google Sheets import will not work', 'error');
                }
                
            } catch (error) {
                console.error('Error in basic functionality test:', error);
                showStatus('Error testing basic functionality: ' + error.message, 'error');
            }
        }

        // Setup auto-sync with other pages
        function setupAutoSync() {
            // Listen for storage events from other pages
            window.addEventListener('storage', function(e) {
                if (e.key === 'cocoonProfiles') {
                    try {
                        const newProfiles = JSON.parse(e.newValue || '[]');
                        profiles = newProfiles;
                        window.cocoonProfiles = profiles;
                        console.log('Profiles synced from other page:', profiles.length);
                        
                        // Refresh UI if on manage tab
                        if (currentTab === 'manage') {
                            refreshProfiles();
                        }
                        updateDataStats();
                    } catch (error) {
                        console.error('Error syncing profiles:', error);
                    }
                }
            });
            
            // Broadcast current profiles to other pages
            if (profiles.length > 0) {
                localStorage.setItem('cocoonProfiles', JSON.stringify(profiles));
            }
        }

        // Auto-load from Google Sheets if no profiles exist
        async function autoLoadFromGoogleSheets() {
            const sheetId = document.getElementById('googleSheetId').value.trim();
            const sheetGid = document.getElementById('googleSheetGid').value.trim();
            
            if (!sheetId || !sheetGid) return;
            
            try {
                showStatus('Auto-loading profiles from Google Sheets...', 'info');
                const sheetData = await fetchGoogleSheetData(sheetId, sheetGid);
                
                profiles = sheetData.map(profile => ({
                    ...profile,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                }));
                
                saveProfiles();
                showStatus(`Auto-loaded ${profiles.length} profiles from Google Sheets`, 'success');
                
                // Refresh UI
                if (currentTab === 'manage') {
                    refreshProfiles();
                }
                updateDataStats();
                
            } catch (error) {
                console.log('Auto-load failed (this is normal if sheet is not accessible):', error.message);
                // Don't show error for auto-load failures
            }
        }

        // Tab switching
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            
            currentTab = tabName;
            
            // Load data for specific tabs
            if (tabName === 'manage') {
                refreshProfiles();
            } else if (tabName === 'export') {
                updateDataStats();
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Search functionality
            document.getElementById('searchProfiles').addEventListener('input', filterProfiles);
            document.getElementById('filterBrand').addEventListener('change', filterProfiles);
            
            // Form submission
            document.getElementById('profileCode').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addProfile();
                }
            });
        }

        // Load profiles from Firebase
        async function loadProfiles() {
            try {
                console.log('Loading profiles from Firebase...');
                
                // Check if Firebase is available
                if (!FirebaseDB || !FirebaseDB.Profiles) {
                    console.warn('Firebase not available, falling back to localStorage');
                    // Fallback to localStorage
                    const savedProfiles = localStorage.getItem('cocoonProfiles');
                    profiles = savedProfiles ? JSON.parse(savedProfiles) : [];
                    console.log(`Loaded ${profiles.length} profiles from localStorage fallback`);
                } else {
                    // Load from Firebase
                    profiles = await FirebaseDB.Profiles.loadProfiles();
                    console.log(`Loaded ${profiles.length} profiles from Firebase`);
                }
                
                // Update global variable for other pages
                window.cocoonProfiles = profiles;
                console.log(`Updated global memory with ${profiles.length} profiles`);
                
                // Debug: show first few profiles
                if (profiles.length > 0) {
                    console.log('First profile:', profiles[0]);
                    console.log('Last profile:', profiles[profiles.length - 1]);
                }
                
                // Display profiles if we're on the manage tab
                if (currentTab === 'manage') {
                    displayProfiles();
                }
            } catch (error) {
                console.error('Error loading profiles from Firebase:', error);
                // Fallback to localStorage
                try {
                    const savedProfiles = localStorage.getItem('cocoonProfiles');
                    profiles = savedProfiles ? JSON.parse(savedProfiles) : [];
                    console.log(`Loaded ${profiles.length} profiles from localStorage fallback after error`);
                } catch (fallbackError) {
                    console.error('Error in localStorage fallback:', fallbackError);
                    profiles = [];
                }
                
                window.cocoonProfiles = profiles;
                showStatus('Error loading profiles from storage', 'error');
                
                // Display profiles if we're on the manage tab (even in fallback)
                if (currentTab === 'manage') {
                    displayProfiles();
                }
            }
        }

        // Save profiles to Firebase
        async function saveProfiles() {
            try {
                // Check if Firebase is available
                if (FirebaseDB && FirebaseDB.Profiles) {
                    // Save to Firebase
                    await FirebaseDB.Profiles.saveProfiles(profiles);
                    console.log(`Saved ${profiles.length} profiles to Firebase`);
                } else {
                    console.warn('Firebase not available, falling back to localStorage');
                    // Fallback to localStorage
                    localStorage.setItem('cocoonProfiles', JSON.stringify(profiles));
                    console.log(`Saved ${profiles.length} profiles to localStorage fallback`);
                }
                
                // Update global variable for other pages
                window.cocoonProfiles = profiles;
                console.log(`Updated global memory with ${profiles.length} profiles`);
                
            } catch (error) {
                console.error('Error saving profiles:', error);
                // Fallback to localStorage if Firebase fails
                try {
                    localStorage.setItem('cocoonProfiles', JSON.stringify(profiles));
                    window.cocoonProfiles = profiles;
                    console.log(`Saved ${profiles.length} profiles to localStorage fallback after error`);
                } catch (fallbackError) {
                    console.error('Error in localStorage fallback:', fallbackError);
                    showStatus('Error saving profiles to storage', 'error');
                }
            }
        }

        // Add new profile
        function addProfile() {
            const profileCode = document.getElementById('profileCode').value.trim();
            const profileName = document.getElementById('profileName').value.trim();
            const system = document.getElementById('system').value.trim();
            
            if (!profileCode || !profileName) {
                showStatus('Profile Code and Profile Name are required', 'error');
                return;
            }
            
            if (!system) {
                showStatus('Please select a System Type', 'error');
                return;
            }
            
            // Check if profile code already exists
            if (profiles.some(p => p.profile_code === profileCode)) {
                showStatus('Profile with this code already exists', 'error');
                return;
            }
            
            const newProfile = {
                profile_code: profileCode,
                profile_name: profileName,
                brand: document.getElementById('brand').value.trim(),
                system: document.getElementById('system').value.trim(),
                max_h: document.getElementById('maxHeight').value ? Number(document.getElementById('maxHeight').value) : null,
                max_w: document.getElementById('maxWidth').value ? Number(document.getElementById('maxWidth').value) : null,
                kg_price: document.getElementById('kgPrice').value ? Number(document.getElementById('kgPrice').value) : 0,
                frame_weight_6m: document.getElementById('frameWeight6m').value ? Number(document.getElementById('frameWeight6m').value) : 0,
                frame_weight_3leaf_6m: document.getElementById('frameWeight3Leaf6m').value ? Number(document.getElementById('frameWeight3Leaf6m').value) : 0,
                leaf_weight_6m: document.getElementById('leafWeight6m').value ? Number(document.getElementById('leafWeight6m').value) : 0,
                frame_price: document.getElementById('framePrice').value ? Number(document.getElementById('framePrice').value) : 0,
                frame_price_3: document.getElementById('framePrice3').value ? Number(document.getElementById('framePrice3').value) : 0,
                leaf_price: document.getElementById('leafPrice').value ? Number(document.getElementById('leafPrice').value) : 0,
                accessories_2_leaves: document.getElementById('accessories2Leaves').value ? Number(document.getElementById('accessories2Leaves').value) : 0,
                accessories_3_leaves: document.getElementById('accessories3Leaves').value ? Number(document.getElementById('accessories3Leaves').value) : 0,
                accessories_4_leaves: document.getElementById('accessories4Leaves').value ? Number(document.getElementById('accessories4Leaves').value) : 0,
                glass_price_single: document.getElementById('glassPriceSingle').value ? Number(document.getElementById('glassPriceSingle').value) : 0,
                glass_price_double: document.getElementById('glassPriceDouble').value ? Number(document.getElementById('glassPriceDouble').value) : 0,
                arc_price: document.getElementById('arcPrice').value ? Number(document.getElementById('arcPrice').value) : 0,
                net_price: document.getElementById('netPrice').value ? Number(document.getElementById('netPrice').value) : 0,
                net_price_plisse: document.getElementById('netPricePlisse').value ? Number(document.getElementById('netPricePlisse').value) : 0,
                net_price_panda: document.getElementById('netPricePanda').value ? Number(document.getElementById('netPricePanda').value) : 0,
                base_profit_rate: document.getElementById('baseProfitRate').value ? Number(document.getElementById('baseProfitRate').value) / 100 : 0.3,
                notes: document.getElementById('notes').value.trim(),
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            };
            
            profiles.push(newProfile);
            saveProfiles();
            
            showStatus(`Profile "${profileName}" added successfully`, 'success');
            clearForm();
            
            // Refresh table if on manage tab
            if (currentTab === 'manage') {
                refreshProfiles();
            }
        }

        // Calculate meter prices based on kg price and 6m weights
        function calculateMeterPrices() {
            const kgPrice = parseFloat(document.getElementById('kgPrice').value) || 0;
            const frameWeight6m = parseFloat(document.getElementById('frameWeight6m').value) || 0;
            const frameWeight3Leaf6m = parseFloat(document.getElementById('frameWeight3Leaf6m').value) || 0;
            const leafWeight6m = parseFloat(document.getElementById('leafWeight6m').value) || 0;
            
            // Calculate frame price per meter (6m weight * kg price / 6)
            if (kgPrice > 0 && frameWeight6m > 0) {
                const framePrice = (frameWeight6m * kgPrice) / 6;
                document.getElementById('framePrice').value = framePrice.toFixed(2);
                document.getElementById('framePriceIndicator').style.display = 'block';
            } else {
                document.getElementById('framePrice').value = '';
                document.getElementById('framePriceIndicator').style.display = 'none';
            }
            
            // Calculate 3-leaf frame price per meter
            if (kgPrice > 0 && frameWeight3Leaf6m > 0) {
                const framePrice3 = (frameWeight3Leaf6m * kgPrice) / 6;
                document.getElementById('framePrice3').value = framePrice3.toFixed(2);
                document.getElementById('framePrice3Indicator').style.display = 'block';
            } else {
                document.getElementById('framePrice3').value = '';
                document.getElementById('framePrice3Indicator').style.display = 'none';
            }
            
            // Calculate leaf price per meter
            if (kgPrice > 0 && leafWeight6m > 0) {
                const leafPrice = (leafWeight6m * kgPrice) / 6;
                document.getElementById('leafPrice').value = leafPrice.toFixed(2);
                document.getElementById('leafPriceIndicator').style.display = 'block';
            } else {
                document.getElementById('leafPrice').value = '';
                document.getElementById('leafPriceIndicator').style.display = 'none';
            }
        }

        // Clear form
        function clearForm() {
            document.getElementById('profileCode').value = '';
            document.getElementById('profileName').value = '';
            document.getElementById('brand').value = '';
            document.getElementById('system').value = '';
            document.getElementById('maxHeight').value = '';
            document.getElementById('maxWidth').value = '';
            document.getElementById('kgPrice').value = '';
            document.getElementById('frameWeight6m').value = '';
            document.getElementById('frameWeight3Leaf6m').value = '';
            document.getElementById('leafWeight6m').value = '';
            document.getElementById('framePrice').value = '';
            document.getElementById('framePrice3').value = '';
            document.getElementById('leafPrice').value = '';
            document.getElementById('accessories2Leaves').value = '';
            document.getElementById('accessories3Leaves').value = '';
            document.getElementById('accessories4Leaves').value = '';
            document.getElementById('glassPriceSingle').value = '';
            document.getElementById('glassPriceDouble').value = '';
            document.getElementById('arcPrice').value = '';
            document.getElementById('netPrice').value = '';
            document.getElementById('netPricePlisse').value = '';
            document.getElementById('netPricePanda').value = '';
            document.getElementById('baseProfitRate').value = '30';
            document.getElementById('notes').value = '';
            
            // Hide calculation indicators
            document.getElementById('framePriceIndicator').style.display = 'none';
            document.getElementById('framePrice3Indicator').style.display = 'none';
            document.getElementById('leafPriceIndicator').style.display = 'none';
        }

        // Refresh profiles table
        function refreshProfiles() {
            console.log('refreshProfiles called');
            loadProfiles();
            console.log('After loadProfiles, profiles count:', profiles.length);
            displayProfiles();
            updateBrandFilters();
            console.log('refreshProfiles complete');
        }

        // Display profiles in table
        function displayProfiles() {
            console.log('displayProfiles called with', profiles.length, 'profiles');
            
            const tbody = document.getElementById('profilesTableBody');
            if (!tbody) {
                console.error('Table body element not found!');
                return;
            }
            
            console.log('Clearing table body...');
            tbody.innerHTML = '';
            
            if (profiles.length === 0) {
                console.log('No profiles to display');
                return;
            }
            
            console.log('Adding profiles to table...');
            profiles.forEach((profile, index) => {
                console.log(`Adding profile ${index}:`, profile.profile_code);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${profile.profile_code}</strong></td>
                    <td>${profile.profile_name}</td>
                    <td>${profile.brand || '-'}</td>
                    <td>${profile.system || '-'}</td>
                    <td>${profile.frame_price ? profile.frame_price.toFixed(2) + ' EGP' : '-'}</td>
                    <td>${profile.leaf_price ? profile.leaf_price.toFixed(2) + ' EGP' : '-'}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-secondary btn-small" onclick="editProfile(${index})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger btn-small" onclick="deleteProfile(${index})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            console.log('Table display complete. Total rows:', tbody.children.length);
        }

        // Update brand filters
        function updateBrandFilters() {
            const brands = [...new Set(profiles.map(p => p.brand).filter(b => b))];
            const filterSelect = document.getElementById('filterBrand');
            const exportSelect = document.getElementById('exportFilter');
            
            // Clear existing options except first
            filterSelect.innerHTML = '<option value="">All Brands</option>';
            exportSelect.innerHTML = '<option value="">All Profiles</option>';
            
            brands.forEach(brand => {
                filterSelect.innerHTML += `<option value="${brand}">${brand}</option>`;
                exportSelect.innerHTML += `<option value="${brand}">${brand}</option>`;
            });
        }

        // Filter profiles
        function filterProfiles() {
            const searchTerm = document.getElementById('searchProfiles').value.toLowerCase();
            const brandFilter = document.getElementById('filterBrand').value;
            
            const filteredProfiles = profiles.filter(profile => {
                const matchesSearch = !searchTerm || 
                    profile.profile_code.toLowerCase().includes(searchTerm) ||
                    profile.profile_name.toLowerCase().includes(searchTerm) ||
                    (profile.brand && profile.brand.toLowerCase().includes(searchTerm));
                
                const matchesBrand = !brandFilter || profile.brand === brandFilter;
                
                return matchesSearch && matchesBrand;
            });
            
            displayFilteredProfiles(filteredProfiles);
        }

        // Display filtered profiles
        function displayFilteredProfiles(filteredProfiles) {
            const tbody = document.getElementById('profilesTableBody');
            tbody.innerHTML = '';
            
            filteredProfiles.forEach((profile, index) => {
                const originalIndex = profiles.findIndex(p => p.profile_code === profile.profile_code);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${profile.profile_code}</strong></td>
                    <td>${profile.profile_name}</td>
                    <td>${profile.brand || '-'}</td>
                    <td>${profile.system || '-'}</td>
                    <td>${profile.frame_price ? profile.frame_price.toFixed(2) + ' EGP' : '-'}</td>
                    <td>${profile.leaf_price ? profile.leaf_price.toFixed(2) + ' EGP' : '-'}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-secondary btn-small" onclick="editProfile(${originalIndex})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger btn-small" onclick="deleteProfile(${originalIndex})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Edit profile
        function editProfile(index) {
            const profile = profiles[index];
            
            document.getElementById('profileCode').value = profile.profile_code;
            document.getElementById('profileName').value = profile.profile_name;
            document.getElementById('brand').value = profile.brand || '';
            document.getElementById('system').value = profile.system || '';
            document.getElementById('maxHeight').value = profile.max_h || '';
            document.getElementById('maxWidth').value = profile.max_w || '';
            document.getElementById('kgPrice').value = profile.kg_price || '';
            document.getElementById('frameWeight6m').value = profile.frame_weight_6m || '';
            document.getElementById('frameWeight3Leaf6m').value = profile.frame_weight_3leaf_6m || '';
            document.getElementById('leafWeight6m').value = profile.leaf_weight_6m || '';
            document.getElementById('framePrice').value = profile.frame_price || '';
            document.getElementById('framePrice3').value = profile.frame_price_3 || '';
            document.getElementById('leafPrice').value = profile.leaf_price || '';
            document.getElementById('accessories2Leaves').value = profile.accessories_2_leaves || '';
            document.getElementById('accessories3Leaves').value = profile.accessories_3_leaves || '';
            document.getElementById('accessories4Leaves').value = profile.accessories_4_leaves || '';
            document.getElementById('glassPriceSingle').value = profile.glass_price_single || '';
            document.getElementById('glassPriceDouble').value = profile.glass_price_double || '';
            document.getElementById('arcPrice').value = profile.arc_price || '';
            document.getElementById('netPrice').value = profile.net_price || '';
            document.getElementById('netPricePlisse').value = profile.net_price_plisse || '';
            document.getElementById('netPricePanda').value = profile.net_price_panda || '';
            document.getElementById('baseProfitRate').value = profile.base_profit_rate ? (profile.base_profit_rate * 100) : '30';
            document.getElementById('notes').value = profile.notes || '';
            
            // Show calculation indicators if values exist
            if (profile.frame_price && profile.frame_price > 0) {
                document.getElementById('framePriceIndicator').style.display = 'block';
            }
            if (profile.frame_price_3 && profile.frame_price_3 > 0) {
                document.getElementById('framePrice3Indicator').style.display = 'block';
            }
            if (profile.leaf_price && profile.leaf_price > 0) {
                document.getElementById('leafPriceIndicator').style.display = 'block';
            }
            
            // Switch to import tab
            switchTab('import');
            
            // Change button text
            const addButton = document.querySelector('.btn-primary');
            addButton.innerHTML = '<i class="fas fa-save"></i> Update Profile';
            addButton.onclick = () => updateProfile(index);
        }

        // Update profile
        function updateProfile(index) {
            const profileCode = document.getElementById('profileCode').value.trim();
            const profileName = document.getElementById('profileName').value.trim();
            const system = document.getElementById('system').value.trim();
            
            if (!profileCode || !profileName) {
                showStatus('Profile Code and Profile Name are required', 'error');
                return;
            }
            
            if (!system) {
                showStatus('Please select a System Type', 'error');
                return;
            }
            
            // Check if profile code already exists (excluding current profile)
            const existingIndex = profiles.findIndex(p => p.profile_code === profileCode);
            if (existingIndex !== -1 && existingIndex !== index) {
                showStatus('Profile with this code already exists', 'error');
                return;
            }
            
            profiles[index] = {
                profile_code: profileCode,
                profile_name: profileName,
                brand: document.getElementById('brand').value.trim(),
                system: document.getElementById('system').value.trim(),
                max_h: document.getElementById('maxHeight').value ? Number(document.getElementById('maxHeight').value) : null,
                max_w: document.getElementById('maxWidth').value ? Number(document.getElementById('maxWidth').value) : null,
                kg_price: document.getElementById('kgPrice').value ? Number(document.getElementById('kgPrice').value) : 0,
                frame_weight_6m: document.getElementById('frameWeight6m').value ? Number(document.getElementById('frameWeight6m').value) : 0,
                frame_weight_3leaf_6m: document.getElementById('frameWeight3Leaf6m').value ? Number(document.getElementById('frameWeight3Leaf6m').value) : 0,
                leaf_weight_6m: document.getElementById('leafWeight6m').value ? Number(document.getElementById('leafWeight6m').value) : 0,
                frame_price: document.getElementById('framePrice').value ? Number(document.getElementById('framePrice').value) : 0,
                frame_price_3: document.getElementById('framePrice3').value ? Number(document.getElementById('framePrice3').value) : 0,
                leaf_price: document.getElementById('leafPrice').value ? Number(document.getElementById('leafPrice').value) : 0,
                accessories_2_leaves: document.getElementById('accessories2Leaves').value ? Number(document.getElementById('accessories2Leaves').value) : 0,
                accessories_3_leaves: document.getElementById('accessories3Leaves').value ? Number(document.getElementById('accessories3Leaves').value) : 0,
                accessories_4_leaves: document.getElementById('accessories4Leaves').value ? Number(document.getElementById('accessories4Leaves').value) : 0,
                glass_price_single: document.getElementById('glassPriceSingle').value ? Number(document.getElementById('glassPriceSingle').value) : 0,
                glass_price_double: document.getElementById('glassPriceDouble').value ? Number(document.getElementById('glassPriceDouble').value) : 0,
                arc_price: document.getElementById('arcPrice').value ? Number(document.getElementById('arcPrice').value) : 0,
                net_price: document.getElementById('netPrice').value ? Number(document.getElementById('netPrice').value) : 0,
                net_price_plisse: document.getElementById('netPricePlisse').value ? Number(document.getElementById('netPricePlisse').value) : 0,
                net_price_panda: document.getElementById('netPricePanda').value ? Number(document.getElementById('netPricePanda').value) : 0,
                base_profit_rate: document.getElementById('baseProfitRate').value ? Number(document.getElementById('baseProfitRate').value) / 100 : 0.3,
                notes: document.getElementById('notes').value.trim(),
                created_at: profiles[index].created_at,
                updated_at: new Date().toISOString()
            };
            
            saveProfiles();
            
            showStatus(`Profile "${profileName}" updated successfully`, 'success');
            clearForm();
            
            // Reset button
            const addButton = document.querySelector('.btn-primary');
            addButton.innerHTML = '<i class="fas fa-plus"></i> Add Profile';
            addButton.onclick = addProfile;
            
            // Refresh table if on manage tab
            if (currentTab === 'manage') {
                refreshProfiles();
            }
        }

        // Delete profile
        function deleteProfile(index) {
            if (confirm('Are you sure you want to delete this profile?')) {
                const profileName = profiles[index].profile_name;
                profiles.splice(index, 1);
                saveProfiles();
                
                showStatus(`Profile "${profileName}" deleted successfully`, 'success');
                
                if (currentTab === 'manage') {
                    refreshProfiles();
                }
            }
        }

        // Clear all profiles
        function clearAllProfiles() {
            if (confirm('Are you sure you want to delete ALL profiles? This action cannot be undone.')) {
                profiles = [];
                saveProfiles();
                
                showStatus('All profiles cleared successfully', 'success');
                
                if (currentTab === 'manage') {
                    refreshProfiles();
                }
            }
        }

        // Import from CSV
        function importFromCSV() {
            document.getElementById('csvFileInput').click();
        }

        // Handle CSV import
        function handleCSVImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            console.log('CSV import started for file:', file.name);
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const csv = e.target.result;
                console.log('CSV content length:', csv.length);
                console.log('CSV preview:', csv.substring(0, 200));
                
                const lines = csv.split('\n');
                console.log('Total lines:', lines.length);
                
                const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                console.log('CSV headers:', headers);
                
                let importedCount = 0;
                let skippedCount = 0;
                let invalidCount = 0;
                
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    
                    const values = line.split(',').map(v => v.trim().replace(/"/g, ''));
                    const profile = {};
                    
                    headers.forEach((header, index) => {
                        profile[header] = values[index] || '';
                    });
                    
                    console.log(`Processing row ${i}:`, profile);
                    
                    // Validate required fields
                    if (profile.profile_code && profile.profile_name && profile.profile_code !== '' && profile.profile_name !== '') {
                        // Check if profile already exists
                        const existingProfile = profiles.find(p => p.profile_code === profile.profile_code);
                        if (!existingProfile) {
                            // Add timestamps
                            profile.created_at = new Date().toISOString();
                            profile.updated_at = new Date().toISOString();
                            
                            // Convert numeric fields
                            const numericFields = ['frame_price', 'frame_price_3', 'leaf_price', 'accessories_2_leaves', 
                                                 'accessories_3_leaves', 'accessories_4_leaves', 'glass_price_single', 
                                                 'glass_price_double', 'arc_price', 'net_price', 'net_price_plisse', 
                                                 'net_price_panda', 'max_h', 'max_w', 'base_profit_rate'];
                            
                            numericFields.forEach(field => {
                                if (profile[field] && !isNaN(Number(profile[field]))) {
                                    profile[field] = Number(profile[field]);
                                } else if (profile[field] === '') {
                                    profile[field] = null;
                                }
                            });
                            
                            profiles.push(profile);
                            importedCount++;
                            console.log(`✅ Imported profile: ${profile.profile_code}`);
                        } else {
                            skippedCount++;
                            console.log(`⏭️ Skipped duplicate: ${profile.profile_code}`);
                        }
                    } else {
                        invalidCount++;
                        console.log(`❌ Invalid row ${i}: missing profile_code or profile_name`);
                    }
                }
                
                console.log(`CSV import summary: ${importedCount} imported, ${skippedCount} skipped, ${invalidCount} invalid`);
                console.log('Total profiles after import:', profiles.length);
                
                // Save to localStorage and update global variable
                saveProfiles();
                
                // Update the display
                if (currentTab === 'manage') {
                    refreshProfiles();
                }
                
                // Update statistics
                updateDataStats();
                
                showStatus(`CSV Import Complete: ${importedCount} imported, ${skippedCount} skipped, ${invalidCount} invalid`, 'success');
            };
            
            reader.onerror = function() {
                console.error('Error reading CSV file');
                showStatus('Error reading CSV file', 'error');
            };
            
            reader.readAsText(file);
            event.target.value = ''; // Reset file input
        }

        // Export profiles
        function exportProfiles() {
            const format = document.getElementById('exportFormat').value;
            const filter = document.getElementById('exportFilter').value;
            
            let exportData = profiles;
            if (filter) {
                exportData = profiles.filter(p => p.brand === filter);
            }
            
            if (format === 'csv') {
                exportToCSV(exportData);
            } else if (format === 'json') {
                exportToJSON(exportData);
            } else if (format === 'excel') {
                exportToExcel(exportData);
            }
        }

        // Export to CSV
        function exportToCSV(data) {
            if (data.length === 0) {
                showStatus('No data to export', 'warning');
                return;
            }
            
            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(','),
                ...data.map(row => headers.map(header => `"${row[header] || ''}"`).join(','))
            ].join('\n');
            
            downloadFile(csvContent, 'profiles.csv', 'text/csv');
        }

        // Export to JSON
        function exportToJSON(data) {
            if (data.length === 0) {
                showStatus('No data to export', 'warning');
                return;
            }
            
            const jsonContent = JSON.stringify(data, null, 2);
            downloadFile(jsonContent, 'profiles.json', 'application/json');
        }

        // Export to Excel (simplified)
        function exportToExcel(data) {
            if (data.length === 0) {
                showStatus('No data to export', 'warning');
                return;
            }
            
            // For now, export as CSV since Excel export requires additional libraries
            exportToCSV(data);
            showStatus('Excel export not available. Exported as CSV instead.', 'warning');
        }

        // Export to Google Sheets format
        function exportToGoogleSheetsFormat() {
            if (profiles.length === 0) {
                showStatus('No profiles to export', 'warning');
                return;
            }
            
            // Define the exact column order for Google Sheets
            const columns = [
                'profile_code', 'Brand', 'profile_name', 'kg_price', 'Frame weight(6M) For 2&4 sachs',
                'frame_price', 'Frame weight(6M) For 3 sachs', 'frame_price_3', 'Sach weight(6M)',
                'leaf_price', 'Mosquito Net Weight(6M)', 'net_price', 'net_price_plisse', 'net_price_panda',
                'Arch trave Weight(6M)', 'arc_price', 'Accessories 2X/windows cost',
                'Accessories 3X/frame cost', 'Accessories 4X/corners cost', 'system', 'max_h', 'max_w',
                'base_profit_rate'
            ];
            
            // Create CSV content with proper column order
            const csvContent = [
                columns.join(','),
                ...profiles.map(profile => 
                    columns.map(col => {
                        const value = profile[col];
                        if (value === null || value === undefined) return '';
                        return `"${String(value).replace(/"/g, '""')}"`;
                    }).join(',')
                )
            ].join('\n');
            
            downloadFile(csvContent, 'profiles-for-google-sheets.csv', 'text/csv');
            showStatus('Profiles exported in Google Sheets format', 'success');
        }

        // Backup all data
        function backupAllData() {
            const backup = {
                profiles: profiles,
                timestamp: new Date().toISOString(),
                version: '1.0'
            };
            
            const jsonContent = JSON.stringify(backup, null, 2);
            downloadFile(jsonContent, `cocoon-backup-${new Date().toISOString().split('T')[0]}.json`, 'application/json');
            showStatus('Backup created successfully', 'success');
        }

        // Update data statistics
        function updateDataStats() {
            const statsDiv = document.getElementById('dataStats');
            if (!statsDiv) return;
            
            const totalProfiles = profiles.length;
            const brands = [...new Set(profiles.map(p => p.brand).filter(b => b))];
            const systems = [...new Set(profiles.map(p => p.system).filter(s => s))];
            
            statsDiv.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                    <div style="text-align: center; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <h4 style="color: var(--cocoon-primary); margin-bottom: 5px;">${totalProfiles}</h4>
                        <p style="font-size: 0.9rem; color: #666;">Total Profiles</p>
                    </div>
                    <div style="text-align: center; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <h4 style="color: var(--cocoon-primary); margin-bottom: 5px;">${brands.length}</h4>
                        <p style="font-size: 0.9rem; color: #666;">Unique Brands</p>
                    </div>
                    <div style="text-align: center; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <h4 style="color: var(--cocoon-primary); margin-bottom: 5px;">${systems.length}</h4>
                        <p style="font-size: 0.9rem; color: #666;">System Types</p>
                    </div>
                </div>
            `;
        }

        // Show status message
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('statusMessage');
            if (!statusDiv) return;
            
            statusDiv.textContent = message;
            statusDiv.className = `status-message status-${type}`;
            statusDiv.style.display = 'block';
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        // Show Google Sheets status
        function showGoogleSheetStatus(message, type = 'info') {
            const statusDiv = document.getElementById('googleSheetStatus');
            if (!statusDiv) return;
            
            statusDiv.textContent = message;
            statusDiv.className = `status-message status-${type}`;
            statusDiv.style.display = 'block';
            
            // Auto-hide after 8 seconds for Google Sheets operations
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 8000);
        }

        // Test Google Sheets connection
        async function testGoogleSheetConnection() {
            const sheetId = document.getElementById('googleSheetId').value.trim();
            const sheetGid = document.getElementById('googleSheetGid').value.trim();
            
            if (!sheetId || !sheetGid) {
                showGoogleSheetStatus('Please enter both Sheet ID and GID', 'error');
                return;
            }
            
            showGoogleSheetStatus('Testing connection to Google Sheets...', 'info');
            
            try {
                const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&gid=${sheetGid}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.text();
                const jsonData = JSON.parse(data.substring(47, data.length - 2));
                
                if (!jsonData.table || !jsonData.table.cols || !jsonData.table.rows) {
                    throw new Error('Invalid sheet structure');
                }
                
                const cols = jsonData.table.cols;
                const requiredColumns = [
                    'profile_code', 'profile_name', 'brand', 'system', 'max_h', 'max_w',
                    'frame_price', 'frame_price_3', 'leaf_price', 'accessories_2_leaves',
                    'accessories_3_leaves', 'accessories_4_leaves', 'glass_price_single',
                    'glass_price_double', 'arc_price', 'net_price', 'net_price_plisse',
                    'net_price_panda', 'base_profit_rate', 'notes'
                ];
                
                const availableColumns = cols.map(col => col.label).filter(label => label);
                const missingColumns = requiredColumns.filter(col => !availableColumns.includes(col));
                
                if (missingColumns.length > 0) {
                    showGoogleSheetStatus(`Connection successful, but missing columns: ${missingColumns.join(', ')}`, 'warning');
                } else {
                    showGoogleSheetStatus(`Connection successful! Found ${jsonData.table.rows.length} rows with all required columns.`, 'success');
                }
                
            } catch (error) {
                console.error('Google Sheets connection error:', error);
                let errorMessage = 'Connection failed';
                
                if (error.message.includes('404')) {
                    errorMessage = 'Sheet not found. Please check the Sheet ID and GID.';
                } else if (error.message.includes('403')) {
                    errorMessage = 'Access denied. Please ensure the sheet is publicly accessible.';
                } else if (error.message.includes('CORS')) {
                    errorMessage = 'CORS error. The sheet needs to be publicly accessible.';
                } else {
                    errorMessage = `Connection error: ${error.message}`;
                }
                
                showGoogleSheetStatus(errorMessage, 'error');
            }
        }

        // Preview Google Sheets data
        async function previewGoogleSheetData() {
            const sheetId = document.getElementById('googleSheetId').value.trim();
            const sheetGid = document.getElementById('googleSheetGid').value.trim();
            
            if (!sheetId || !sheetGid) {
                showGoogleSheetStatus('Please enter both Sheet ID and GID', 'error');
                return;
            }
            
            showGoogleSheetStatus('Loading preview data from Google Sheets...', 'info');
            
            try {
                const sheetData = await fetchGoogleSheetData(sheetId, sheetGid);
                displaySheetPreview(sheetData);
                showGoogleSheetStatus(`Preview loaded: ${sheetData.length} profiles found`, 'success');
            } catch (error) {
                console.error('Preview error:', error);
                showGoogleSheetStatus(`Preview failed: ${error.message}`, 'error');
            }
        }

        // Import from Google Sheets
        async function importFromGoogleSheets() {
            const sheetId = document.getElementById('googleSheetId').value.trim();
            const sheetGid = document.getElementById('googleSheetGid').value.trim();
            
            if (!sheetId || !sheetGid) {
                showGoogleSheetStatus('Please enter both Sheet ID and GID', 'error');
                return;
            }
            
            const importMode = confirm('Choose import mode:\n\nOK = Replace all existing profiles\nCancel = Merge with existing profiles (update existing, add new)');
            
            showGoogleSheetStatus('Importing profiles from Google Sheets...', 'info');
            
            try {
                const sheetData = await fetchGoogleSheetData(sheetId, sheetGid);
                
                if (importMode) {
                    // Replace all existing profiles
                    profiles = sheetData.map(profile => ({
                        ...profile,
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    }));
                    
                    showGoogleSheetStatus(`Successfully imported ${profiles.length} profiles from Google Sheets (replaced all existing)`, 'success');
                } else {
                    // Merge with existing profiles
                    let addedCount = 0;
                    let updatedCount = 0;
                    
                    sheetData.forEach(sheetProfile => {
                        const existingIndex = profiles.findIndex(p => p.profile_code === sheetProfile.profile_code);
                        
                        if (existingIndex === -1) {
                            // Add new profile
                            profiles.push({
                                ...sheetProfile,
                                created_at: new Date().toISOString(),
                                updated_at: new Date().toISOString()
                            });
                            addedCount++;
                        } else {
                            // Update existing profile
                            profiles[existingIndex] = {
                                ...profiles[existingIndex],
                                ...sheetProfile,
                                created_at: profiles[existingIndex].created_at,
                                updated_at: new Date().toISOString()
                            };
                            updatedCount++;
                        }
                    });
                    
                    showGoogleSheetStatus(`Successfully merged profiles: ${addedCount} added, ${updatedCount} updated`, 'success');
                }
                
                saveProfiles();
                
                // Refresh tables if on manage tab
                if (currentTab === 'manage') {
                    refreshProfiles();
                }
                
                // Update statistics
                updateDataStats();
                
            } catch (error) {
                console.error('Import error:', error);
                showGoogleSheetStatus(`Import failed: ${error.message}`, 'error');
            }
        }

        // Fetch Google Sheets data
        async function fetchGoogleSheetData(sheetId, sheetGid) {
            const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&gid=${sheetGid}`;
            const response = await fetch(url);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.text();
            const jsonData = JSON.parse(data.substring(47, data.length - 2));
            
            if (!jsonData.table || !jsonData.table.cols || !jsonData.table.rows) {
                throw new Error('Invalid sheet structure');
            }
            
            const cols = jsonData.table.cols;
            const rows = jsonData.table.rows;
            
            if (!rows || rows.length === 0) {
                throw new Error('No data found in the spreadsheet');
            }
            
            // Create mapping of column names
            const colMap = {};
            cols.forEach((col, index) => {
                if (col.label) colMap[col.label] = index;
            });
            
            // Validate required columns
            const requiredColumns = ['profile_code', 'profile_name'];
            const missingColumns = requiredColumns.filter(col => !colMap[col]);
            
            if (missingColumns.length > 0) {
                throw new Error(`Missing required columns: ${missingColumns.join(', ')}`);
            }
            
            // Extract profile data
            const profiles = rows.map((row, rowIndex) => {
                const profile = {};
                Object.keys(colMap).forEach(key => {
                    const colIndex = colMap[key];
                    const value = row.c[colIndex] ? row.c[colIndex].v : null;
                    
                    // Convert numeric values
                    if (typeof value === 'number') {
                        profile[key] = value;
                    } else if (value && !isNaN(Number(value))) {
                        profile[key] = Number(value);
                    } else {
                        profile[key] = value;
                    }
                });
                
                // Validate required fields
                if (!profile.profile_code || !profile.profile_name) {
                    console.warn(`Row ${rowIndex + 1}: Missing required fields (profile_code or profile_name)`);
                }
                
                return profile;
            }).filter(profile => profile.profile_code && profile.profile_name); // Filter out invalid rows
            
            if (profiles.length === 0) {
                throw new Error('No valid profiles found in the spreadsheet (missing profile_code or profile_name)');
            }
            
            return profiles;
        }

        // Display sheet preview
        function displaySheetPreview(sheetData) {
            const previewDiv = document.getElementById('googleSheetPreview');
            const tbody = document.getElementById('previewTableBody');
            
            if (!previewDiv || !tbody) return;
            
            tbody.innerHTML = '';
            
            sheetData.slice(0, 10).forEach((profile, index) => { // Show first 10 rows
                const row = document.createElement('tr');
                const status = profile.profile_code && profile.profile_name ? 'Valid' : 'Missing Data';
                const statusClass = status === 'Valid' ? 'success' : 'warning';
                
                row.innerHTML = `
                    <td><strong>${profile.profile_code || 'N/A'}</strong></td>
                    <td>${profile.profile_name || 'N/A'}</td>
                    <td>${profile.brand || '-'}</td>
                    <td>${profile.system || '-'}</td>
                    <td>${profile.frame_price ? profile.frame_price.toFixed(2) + ' EGP' : '-'}</td>
                    <td>${profile.leaf_price ? profile.leaf_price.toFixed(2) + ' EGP' : '-'}</td>
                    <td><span class="status-${statusClass}" style="padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">${status}</span></td>
                `;
                tbody.appendChild(row);
            });
            
            previewDiv.style.display = 'block';
            
            if (sheetData.length > 10) {
                const moreInfo = document.createElement('div');
                moreInfo.style.marginTop = '10px';
                moreInfo.style.textAlign = 'center';
                moreInfo.style.color = '#666';
                moreInfo.textContent = `Showing first 10 of ${sheetData.length} profiles`;
                previewDiv.appendChild(moreInfo);
            }
        }

        // Download sample CSV
        function downloadSampleCSV() {
            const sampleData = [
                {
                    profile_code: 'ALU-WIN-001',
                    Brand: 'Cocoon',
                    profile_name: 'Premium Sliding Window',
                    kg_price: 15.5,
                    'Frame weight(6M) For 2&4 sachs': 25.0,
                    frame_price: 150.00,
                    'Frame weight(6M) For 3 sachs': 30.0,
                    frame_price_3: 180.00,
                    'Sach weight(6M)': 12.0,
                    leaf_price: 120.00,
                    'Mosquito Net Weight(6M)': 8.0,
                    net_price: 60.00,
                    net_price_plisse: 80.00,
                    net_price_panda: 100.00,
                    'Arch trave Weight(6M)': 5.0,
                    arc_price: 200.00,
                    'Accessories 2X/windows cost': 50.00,
                    'Accessories 3X/frame cost': 75.00,
                    'Accessories 4X/corners cost': 100.00,
                    system: 'Sliding',
                    max_h: 3000,
                    max_w: 6000,
                    base_profit_rate: 30
                },
                {
                    profile_code: 'ALU-WIN-002',
                    Brand: 'Cocoon',
                    profile_name: 'Standard Hinged Window',
                    kg_price: 12.0,
                    'Frame weight(6M) For 2&4 sachs': 20.0,
                    frame_price: 120.00,
                    'Frame weight(6M) For 3 sachs': 25.0,
                    frame_price_3: 150.00,
                    'Sach weight(6M)': 10.0,
                    leaf_price: 100.00,
                    'Mosquito Net Weight(6M)': 6.0,
                    net_price: 50.00,
                    net_price_plisse: 70.00,
                    net_price_panda: 90.00,
                    'Arch trave Weight(6M)': 4.0,
                    arc_price: 180.00,
                    'Accessories 2X/windows cost': 40.00,
                    'Accessories 3X/frame cost': 60.00,
                    'Accessories 4X/corners cost': 80.00,
                    system: 'Hinged',
                    max_h: 2500,
                    max_w: 4000,
                    base_profit_rate: 25
                }
            ];
            
            const columns = [
                'profile_code', 'profile_name', 'brand', 'system', 'max_h', 'max_w',
                'frame_price', 'frame_price_3', 'leaf_price', 'accessories_2_leaves',
                'accessories_3_leaves', 'accessories_4_leaves', 'glass_price_single',
                'glass_price_double', 'arc_price', 'net_price', 'net_price_plisse',
                'net_price_panda', 'base_profit_rate', 'notes'
            ];
            
            const csvContent = [
                columns.join(','),
                ...sampleData.map(profile => 
                    columns.map(col => {
                        const value = profile[col];
                        if (value === null || value === undefined) return '';
                        return `"${String(value).replace(/"/g, '""')}"`;
                    }).join(',')
                )
            ].join('\n');
            
            downloadFile(csvContent, 'sample-profiles.csv', 'text/csv');
            showGoogleSheetStatus('Sample CSV downloaded successfully', 'success');
        }

        // Show Google Sheets status
        function showGoogleSheetStatus(message, type = 'info') {
            const statusDiv = document.getElementById('googleSheetStatus');
            if (!statusDiv) return;
            
            statusDiv.textContent = message;
            statusDiv.className = `status-message status-${type}`;
            statusDiv.style.display = 'block';
            
            // Auto-hide after 8 seconds for Google Sheets operations
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 8000);
        }

        // Test Google Sheets connection
        async function testGoogleSheetConnection() {
            const sheetId = document.getElementById('googleSheetId').value.trim();
            const sheetGid = document.getElementById('googleSheetGid').value.trim();
            
            if (!sheetId || !sheetGid) {
                showGoogleSheetStatus('Please enter both Sheet ID and GID', 'error');
                return;
            }
            
            showGoogleSheetStatus('Testing connection to Google Sheets...', 'info');
            
            try {
                const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&gid=${sheetGid}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.text();
                const jsonData = JSON.parse(data.substring(47, data.length - 2));
                
                if (!jsonData.table || !jsonData.table.cols || !jsonData.table.rows) {
                    throw new Error('Invalid sheet structure');
                }
                
                const cols = jsonData.table.cols;
                const requiredColumns = [
                    'profile_code', 'profile_name', 'brand', 'system', 'max_h', 'max_w',
                    'frame_price', 'frame_price_3', 'leaf_price', 'accessories_2_leaves',
                    'accessories_3_leaves', 'accessories_4_leaves', 'glass_price_single',
                    'glass_price_double', 'arc_price', 'net_price', 'net_price_plisse',
                    'net_price_panda', 'base_profit_rate', 'notes'
                ];
                
                const availableColumns = cols.map(col => col.label).filter(label => label);
                const missingColumns = requiredColumns.filter(col => !availableColumns.includes(col));
                
                if (missingColumns.length > 0) {
                    showGoogleSheetStatus(`Connection successful, but missing columns: ${missingColumns.join(', ')}`, 'warning');
                } else {
                    showGoogleSheetStatus(`Connection successful! Found ${jsonData.table.rows.length} rows with all required columns.`, 'success');
                }
                
            } catch (error) {
                console.error('Google Sheets connection error:', error);
                let errorMessage = 'Connection failed';
                
                if (error.message.includes('404')) {
                    errorMessage = 'Sheet not found. Please check the Sheet ID and GID.';
                } else if (error.message.includes('403')) {
                    errorMessage = 'Access denied. Please ensure the sheet is publicly accessible.';
                } else if (error.message.includes('CORS')) {
                    errorMessage = 'CORS error. The sheet needs to be publicly accessible.';
                } else {
                    errorMessage = `Connection error: ${error.message}`;
                }
                
                showGoogleSheetStatus(errorMessage, 'error');
            }
        }

        // Preview Google Sheets data
        async function previewGoogleSheetData() {
            const sheetId = document.getElementById('googleSheetId').value.trim();
            const sheetGid = document.getElementById('googleSheetGid').value.trim();
            
            if (!sheetId || !sheetGid) {
                showGoogleSheetStatus('Please enter both Sheet ID and GID', 'error');
                return;
            }
            
            showGoogleSheetStatus('Loading preview data from Google Sheets...', 'info');
            
            try {
                const sheetData = await fetchGoogleSheetData(sheetId, sheetGid);
                displaySheetPreview(sheetData);
                showGoogleSheetStatus(`Preview loaded: ${sheetData.length} profiles found`, 'success');
            } catch (error) {
                console.error('Preview error:', error);
                showGoogleSheetStatus(`Preview failed: ${error.message}`, 'error');
            }
        }

        // Import from Google Sheets
        async function importFromGoogleSheets() {
            const sheetId = document.getElementById('googleSheetId').value.trim();
            const sheetGid = document.getElementById('googleSheetGid').value.trim();
            
            if (!sheetId || !sheetGid) {
                showGoogleSheetStatus('Please enter both Sheet ID and GID', 'error');
                return;
            }
            
            const importMode = confirm('Choose import mode:\n\nOK = Replace all existing profiles\nCancel = Merge with existing profiles (update existing, add new)');
            
            showGoogleSheetStatus('Importing profiles from Google Sheets...', 'info');
            
            try {
                const sheetData = await fetchGoogleSheetData(sheetId, sheetGid);
                
                if (importMode) {
                    // Replace all existing profiles
                    profiles = sheetData.map(profile => ({
                        ...profile,
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    }));
                    
                    showGoogleSheetStatus(`Successfully imported ${profiles.length} profiles from Google Sheets (replaced all existing)`, 'success');
                } else {
                    // Merge with existing profiles
                    let addedCount = 0;
                    let updatedCount = 0;
                    
                    sheetData.forEach(sheetProfile => {
                        const existingIndex = profiles.findIndex(p => p.profile_code === sheetProfile.profile_code);
                        
                        if (existingIndex === -1) {
                            // Add new profile
                            profiles.push({
                                ...sheetProfile,
                                created_at: new Date().toISOString(),
                                updated_at: new Date().toISOString()
                            });
                            addedCount++;
                        } else {
                            // Update existing profile
                            profiles[existingIndex] = {
                                ...profiles[existingIndex],
                                ...sheetProfile,
                                created_at: profiles[existingIndex].created_at,
                                updated_at: new Date().toISOString()
                            };
                            updatedCount++;
                        }
                    });
                    
                    showGoogleSheetStatus(`Successfully merged profiles: ${addedCount} added, ${updatedCount} updated`, 'success');
                }
                
                saveProfiles();
                
                // Refresh tables if on manage tab
                if (currentTab === 'manage') {
                    refreshProfiles();
                }
                
                // Update statistics
                updateDataStats();
                
            } catch (error) {
                console.error('Import error:', error);
                showGoogleSheetStatus(`Import failed: ${error.message}`, 'error');
            }
        }

        // Fetch Google Sheets data
        async function fetchGoogleSheetData(sheetId, sheetGid) {
            const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&gid=${sheetGid}`;
            const response = await fetch(url);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.text();
            const jsonData = JSON.parse(data.substring(47, data.length - 2));
            
            if (!jsonData.table || !jsonData.table.cols || !jsonData.table.rows) {
                throw new Error('Invalid sheet structure');
            }
            
            const cols = jsonData.table.cols;
            const rows = jsonData.table.rows;
            
            if (!rows || rows.length === 0) {
                throw new Error('No data found in the spreadsheet');
            }
            
            // Create mapping of column names
            const colMap = {};
            cols.forEach((col, index) => {
                if (col.label) colMap[col.label] = index;
            });
            
            // Validate required columns
            const requiredColumns = ['profile_code', 'profile_name'];
            const missingColumns = requiredColumns.filter(col => !colMap[col]);
            
            if (missingColumns.length > 0) {
                throw new Error(`Missing required columns: ${missingColumns.join(', ')}`);
            }
            
            // Extract profile data
            const profiles = rows.map((row, rowIndex) => {
                const profile = {};
                Object.keys(colMap).forEach(key => {
                    const colIndex = colMap[key];
                    const value = row.c[colIndex] ? row.c[colIndex].v : null;
                    
                    // Convert numeric values
                    if (typeof value === 'number') {
                        profile[key] = value;
                    } else if (value && !isNaN(Number(value))) {
                        profile[key] = Number(value);
                    } else {
                        profile[key] = value;
                    }
                });
                
                // Validate required fields
                if (!profile.profile_code || !profile.profile_name) {
                    console.warn(`Row ${rowIndex + 1}: Missing required fields (profile_code or profile_name)`);
                }
                
                return profile;
            }).filter(profile => profile.profile_code && profile.profile_name); // Filter out invalid rows
            
            if (profiles.length === 0) {
                throw new Error('No valid profiles found in the spreadsheet (missing profile_code or profile_name)');
            }
            
            return profiles;
        }

        // Display sheet preview
        function displaySheetPreview(sheetData) {
            const previewDiv = document.getElementById('googleSheetPreview');
            const tbody = document.getElementById('previewTableBody');
            
            if (!previewDiv || !tbody) return;
            
            tbody.innerHTML = '';
            
            sheetData.slice(0, 10).forEach((profile, index) => { // Show first 10 rows
                const row = document.createElement('tr');
                const status = profile.profile_code && profile.profile_name ? 'Valid' : 'Missing Data';
                const statusClass = status === 'Valid' ? 'success' : 'warning';
                
                row.innerHTML = `
                    <td><strong>${profile.profile_code || 'N/A'}</strong></td>
                    <td>${profile.profile_name || 'N/A'}</td>
                    <td>${profile.brand || '-'}</td>
                    <td>${profile.system || '-'}</td>
                    <td>${profile.frame_price ? profile.frame_price.toFixed(2) + ' EGP' : '-'}</td>
                    <td>${profile.leaf_price ? profile.leaf_price.toFixed(2) + ' EGP' : '-'}</td>
                    <td><span class="status-${statusClass}" style="padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">${status}</span></td>
                `;
                tbody.appendChild(row);
            });
            
            previewDiv.style.display = 'block';
            
            if (sheetData.length > 10) {
                const moreInfo = document.createElement('div');
                moreInfo.style.marginTop = '10px';
                moreInfo.style.textAlign = 'center';
                moreInfo.style.color = '#666';
                moreInfo.textContent = `Showing first 10 of ${sheetData.length} profiles`;
                previewDiv.appendChild(moreInfo);
            }
        }

        // Map column names from your sheet structure
        function mapColumnNames(originalKey) {
            const columnMappings = {
                'Brand': 'brand',
                'Accessories 2X/windows cost': 'accessories_2_leaves',
                'Accessories 3X/frame cost': 'accessories_3_leaves',
                'Accessories 4X/corners cost': 'accessories_4_leaves'
            };
            return columnMappings[originalKey] || originalKey;
        }

        // Debug column names
        async function debugColumnNames() {
            const sheetId = document.getElementById('googleSheetId').value.trim();
            const sheetGid = document.getElementById('googleSheetGid').value.trim();
            
            if (!sheetId || !sheetGid) {
                showGoogleSheetStatus('Please enter both Sheet ID and GID', 'error');
                return;
            }
            
            showGoogleSheetStatus('Debugging column names...', 'info');
            
            try {
                const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&gid=${sheetGid}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.text();
                const jsonData = JSON.parse(data.substring(47, data.length - 2));
                
                if (!jsonData.table || !jsonData.table.cols) {
                    throw new Error('Invalid sheet structure');
                }
                
                const cols = jsonData.table.cols;
                const colMap = {};
                cols.forEach((col, index) => {
                    if (col.label) colMap[col.label] = index;
                });
                
                console.log('=== COLUMN DEBUG INFO ===');
                console.log('Available columns:', Object.keys(colMap));
                console.log('Total columns found:', Object.keys(colMap).length);
                
                // Check for profile code variations
                const profileCodeVariations = ['profile_code', 'Profile Code', 'PROFILE_CODE', 'code', 'Code', 'CODE'];
                const profileNameVariations = ['profile_name', 'Profile Name', 'PROFILE_NAME', 'name', 'Name', 'NAME'];
                
                console.log('Looking for profile code in:', profileCodeVariations);
                console.log('Looking for profile name in:', profileNameVariations);
                
                let foundProfileCode = null;
                let foundProfileName = null;
                
                for (const variation of profileCodeVariations) {
                    if (colMap[variation]) {
                        foundProfileCode = variation;
                        console.log(`✅ Found profile code column: "${variation}"`);
                        break;
                    }
                }
                
                for (const variation of profileNameVariations) {
                    if (colMap[variation]) {
                        foundProfileName = variation;
                        console.log(`✅ Found profile name column: "${variation}"`);
                        break;
                    }
                }
                
                if (!foundProfileCode) {
                    console.log('❌ No profile code column found');
                }
                
                if (!foundProfileName) {
                    console.log('❌ No profile name column found');
                }
                
                // Show results in status
                let statusMessage = `Found ${Object.keys(colMap).length} columns: ${Object.keys(colMap).join(', ')}`;
                if (foundProfileCode) {
                    statusMessage += ` | Profile Code: "${foundProfileCode}"`;
                } else {
                    statusMessage += ` | ❌ No profile code found`;
                }
                if (foundProfileName) {
                    statusMessage += ` | Profile Name: "${foundProfileName}"`;
                } else {
                    statusMessage += ` | ❌ No profile name found`;
                }
                
                // Additional debug info
                console.log('=== DETAILED COLUMN ANALYSIS ===');
                console.log('All column names:', Object.keys(colMap));
                console.log('profile_code in colMap:', colMap['profile_code']);
                console.log('profile_name in colMap:', colMap['profile_name']);
                console.log('hasOwnProperty profile_code:', colMap.hasOwnProperty('profile_code'));
                console.log('hasOwnProperty profile_name:', colMap.hasOwnProperty('profile_name'));
                
                showGoogleSheetStatus(statusMessage, foundProfileCode && foundProfileName ? 'success' : 'warning');
                
            } catch (error) {
                console.error('Debug error:', error);
                showGoogleSheetStatus(`Debug failed: ${error.message}`, 'error');
            }
        }

        // Working fetch function - use this instead of the old one
        async function fetchGoogleSheetDataWorking(sheetId, sheetGid) {
            const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&gid=${sheetGid}`;
            const response = await fetch(url);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.text();
            const jsonData = JSON.parse(data.substring(47, data.length - 2));
            
            if (!jsonData.table || !jsonData.table.cols) {
                throw new Error('Invalid sheet structure');
            }
            
            const cols = jsonData.table.cols;
            const rows = jsonData.table.rows || [];
            
            // Create mapping of column names
            const colMap = {};
            cols.forEach((col, index) => {
                if (col.label) {
                    colMap[col.label] = index;
                }
            });
            
            // Check if required columns exist
            if (!colMap.hasOwnProperty('profile_code')) {
                throw new Error(`profile_code column not found. Available: ${Object.keys(colMap).join(', ')}`);
            }
            
            if (!colMap.hasOwnProperty('profile_name')) {
                throw new Error(`profile_name column not found. Available: ${Object.keys(colMap).join(', ')}`);
            }
            
            // Extract profile data
            const profiles = rows.map((row, rowIndex) => {
                const profile = {};
                Object.keys(colMap).forEach(key => {
                    const colIndex = colMap[key];
                    const value = row.c[colIndex] ? row.c[colIndex].v : null;
                    
                    // Handle profile_code and profile_name as strings
                    if (key === 'profile_code' || key === 'profile_name') {
                        profile[key] = value ? value.toString().trim() : '';
                    }
                    // Convert other numeric values
                    else if (typeof value === 'number') {
                        profile[key] = value;
                    } else if (value && !isNaN(Number(value))) {
                        profile[key] = Number(value);
                    } else {
                        profile[key] = value;
                    }
                });
                
                return profile;
            }).filter(profile => profile.profile_code && profile.profile_code !== '' && profile.profile_name && profile.profile_name !== '');
            
            if (profiles.length === 0) {
                throw new Error('No valid profiles found in the spreadsheet');
            }
            
            return profiles;
        }

        // Test import directly with detailed logging
        async function testImportDirectly() {
            const sheetId = document.getElementById('googleSheetId').value.trim();
            const sheetGid = document.getElementById('googleSheetGid').value.trim();
            
            if (!sheetId || !sheetGid) {
                showGoogleSheetStatus('Please enter both Sheet ID and GID', 'error');
                return;
            }
            
            showGoogleSheetStatus('Testing import directly...', 'info');
            
            try {
                console.log('=== DIRECT IMPORT TEST ===');
                const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&gid=${sheetGid}`;
                console.log('Fetching from:', url);
                
                const response = await fetch(url);
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.text();
                console.log('Raw data length:', data.length);
                console.log('Raw data preview:', data.substring(0, 200));
                
                const jsonData = JSON.parse(data.substring(47, data.length - 2));
                console.log('Parsed JSON structure:', {
                    hasTable: !!jsonData.table,
                    hasCols: !!jsonData.table?.cols,
                    hasRows: !!jsonData.table?.rows,
                    colsCount: jsonData.table?.cols?.length || 0,
                    rowsCount: jsonData.table?.rows?.length || 0
                });
                
                if (!jsonData.table || !jsonData.table.cols) {
                    throw new Error('Invalid sheet structure');
                }
                
                const cols = jsonData.table.cols;
                const rows = jsonData.table.rows || [];
                
                console.log('Columns found:', cols.map(col => col.label || 'Unnamed'));
                console.log('Rows count:', rows.length);
                
                // Create mapping of column names
                const colMap = {};
                cols.forEach((col, index) => {
                    if (col.label) {
                        colMap[col.label] = index;
                        console.log(`Column "${col.label}" mapped to index ${index}`);
                    }
                });
                
                console.log('Final colMap:', colMap);
                console.log('profile_code exists:', colMap.hasOwnProperty('profile_code'));
                console.log('profile_name exists:', colMap.hasOwnProperty('profile_name'));
                
                // Check if required columns exist
                if (!colMap.hasOwnProperty('profile_code')) {
                    throw new Error(`profile_code column not found. Available: ${Object.keys(colMap).join(', ')}`);
                }
                
                if (!colMap.hasOwnProperty('profile_name')) {
                    throw new Error(`profile_name column not found. Available: ${Object.keys(colMap).join(', ')}`);
                }
                
                // Test extracting first row
                if (rows.length > 0) {
                    const firstRow = rows[0];
                    console.log('First row data:', firstRow);
                    
                    if (firstRow && firstRow.c) {
                        const profileCode = firstRow.c[colMap['profile_code']]?.v;
                        const profileName = firstRow.c[colMap['profile_name']]?.v;
                        
                        // Convert to strings
                        const profileCodeStr = profileCode ? profileCode.toString().trim() : '';
                        const profileNameStr = profileName ? profileName.toString().trim() : '';
                        
                        console.log('Extracted profile_code (raw):', profileCode, 'type:', typeof profileCode);
                        console.log('Extracted profile_code (string):', profileCodeStr);
                        console.log('Extracted profile_name (raw):', profileName, 'type:', typeof profileName);
                        console.log('Extracted profile_name (string):', profileNameStr);
                        
                        showGoogleSheetStatus(`✅ Test successful! Found profile_code: "${profileCodeStr}", profile_name: "${profileNameStr}"`, 'success');
                    } else {
                        showGoogleSheetStatus('⚠️ First row has no data', 'warning');
                    }
                } else {
                    showGoogleSheetStatus('⚠️ No rows found in sheet', 'warning');
                }
                
            } catch (error) {
                console.error('Test import error:', error);
                showGoogleSheetStatus(`Test failed: ${error.message}`, 'error');
            }
        }

        // Debug profiles function
        function debugProfiles() {
            console.log('=== PROFILES DEBUG ===');
            console.log('Current profiles array length:', profiles.length);
            console.log('Global cocoonProfiles length:', window.cocoonProfiles ? window.cocoonProfiles.length : 'undefined');
            console.log('localStorage cocoonProfiles:', localStorage.getItem('cocoonProfiles') ? 'exists' : 'not found');
            
            if (profiles.length > 0) {
                console.log('First profile:', profiles[0]);
                console.log('Last profile:', profiles[profiles.length - 1]);
                console.log('Sample profiles:', profiles.slice(0, 3));
            } else {
                console.log('No profiles in memory');
            }
            
            // Check if table is displaying correctly
            const tbody = document.getElementById('profilesTableBody');
            if (tbody) {
                console.log('Table body exists, rows:', tbody.children.length);
            } else {
                console.log('Table body not found');
            }
            
            // Check current tab
            console.log('Current tab:', currentTab);
            
            // Force refresh
            console.log('Forcing refresh...');
            refreshProfiles();
            
            // Force switch to manage tab if not already there
            if (currentTab !== 'manage') {
                console.log('Switching to manage tab...');
                switchTab('manage');
            }
            
            showGoogleSheetStatus(`Debug complete. Check console for details. Profiles: ${profiles.length}`, 'info');
        }

        // Force display profiles
        function forceDisplayProfiles() {
            console.log('=== FORCE DISPLAY PROFILES ===');
            
            // Switch to manage tab
            switchTab('manage');
            
            // Wait a moment for tab to switch
            setTimeout(() => {
                console.log('Forcing display after tab switch...');
                loadProfiles();
                displayProfiles();
                updateBrandFilters();
                
                const tbody = document.getElementById('profilesTableBody');
                if (tbody) {
                    console.log('Final table rows:', tbody.children.length);
                    showGoogleSheetStatus(`Force display complete. Table has ${tbody.children.length} rows.`, 'success');
                } else {
                    console.error('Table body still not found!');
                    showGoogleSheetStatus('Error: Table body not found!', 'error');
                }
            }, 100);
        }

        // Simple test function to check profiles
        function testProfilesDisplay() {
            console.log('=== SIMPLE PROFILES TEST ===');
            console.log('Current tab:', currentTab);
            console.log('Profiles count:', profiles.length);
            
            // Force load from localStorage
            const savedProfiles = localStorage.getItem('cocoonProfiles');
            console.log('localStorage data:', savedProfiles ? 'exists' : 'not found');
            
            if (savedProfiles) {
                const parsedProfiles = JSON.parse(savedProfiles);
                console.log('Parsed profiles count:', parsedProfiles.length);
                console.log('First profile:', parsedProfiles[0]);
                
                // Update the global profiles array
                profiles = parsedProfiles;
                window.cocoonProfiles = profiles;
                
                // Display them
                displayProfiles();
                
                const tbody = document.getElementById('profilesTableBody');
                console.log('Table rows after display:', tbody ? tbody.children.length : 'table not found');
            }
            
            showGoogleSheetStatus(`Test complete. Profiles: ${profiles.length}`, 'info');
        }

        // Logout function
        function logout() {
            localStorage.removeItem('loggedIn');
            localStorage.removeItem('loginTime');
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>